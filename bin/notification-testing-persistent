#!/bin/bash

notify() {
    local level="${1:-normal}"
    local body="$(cat)"

    notify-send.sh -t 5000 -r 31337 -u $level " " -- "$body"
}

state_failed=false
last_line=""

notify <<< "testing..."

while read line; do
    if [ ! -n "$line" ]; then
        continue
    fi

    last_line="$line"
done

level="normal"
if grep -q "TEST FAILED" <<< "$last_line"; then
    level="low"
fi

body=$(sed 's/### //g' <<< "$last_line")
notify "$level" <<< "$body"
