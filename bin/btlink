#!/bin/bash

declare -A devices

devices=(
    [philips]="A0:E9:DB:06:62:EF"
    [zik]="A0:14:3D:CE:14:CF"
    [ueboom]="C0:28:8D:35:3D:ED"
    [interstep]="28:52:E0:21:73:7C"
)

TIMEOUT=${TIMEOUT:-10}

:main() {
    if :interactive; then
        device="${1:-}"
    fi

    if [[ ! "$device" ]]; then
        device=$(
            for key in "${!devices[@]}"; do
                echo $key;
            done | modal
        )
    fi

    addr=${devices[${device}]:-}
    if [[ ! "$addr" ]]; then
        echo "no such device" >&2
        :notify "no such device"
    fi

    title=$(tr '[[:lower:]]' '[[:upper:]]' <<< "$device")

    while :; do
        sudo systemctl restart bluetooth
        :notify "<b>BTLINK</b> CONNECTING TO <b>${title}</b>"

        { sleep ${TIMEOUT} && pkill blueco; } &
        killer=$!

        if blueco "${addr}"; then
            :notify "<b>BTLINK</b> LINKED TO <b>${title}</b>"
            exit 0
        fi

        kill $killer
    done
}

:notify() {
    notify-send.sh -r 2000 -t 200 "btlink" "${*}"
}

:interactive() {
    if [ -t 1 ]; then
        return 0
    fi

    return 1;
}

:main "${@}"
