#!/bin/bash

TIMEOUT=${TIMEOUT:-3}

:main() {
    if :interactive; then
        name="$1"
    else
        name=$(echo -e "philips\nzik" | modal)
    fi

    addr=""
    case "$name" in
        philips)
            addr="A0:E9:DB:06:62:EF"
            ;;

        zik)
            addr="A0:14:3D:CE:14:CF"
            ;;
        *)
            echo "unknown device: ${name}"
            exit 1
            ;;
    esac

    name=$(tr '[[:lower:]]' '[[:upper:]]' <<< "$name")

    :notify() {
        notify-send.sh -r 2000 -t 200 "btlink" "${*}"
    }

    while :; do
        sudo systemctl restart bluetooth
        :notify "<b>BLUETOOTH</b>: CONNECTING TO ${name}"

        { sleep ${TIMEOUT} && pkill blueco; } &
        killer=$!

        if blueco "${addr}"; then
            :notify "<b>BLUETOOTH</b>: LINKED"
            exit 0
        else
            :notify "<b>BLUETOOTH</b>: ERROR"
        fi

        kill $killer
    done
}

:interactive() {
    if [ -t 1 ]; then
        return 0
    fi

    return 1;
}

:main "${@}"
