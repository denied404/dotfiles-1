#!/bin/bash

args="$@"

sub="$(echo "$args" | rev | cut -d / -f 1 | rev)"
rus_sub="rus/$sub"

mplayer "$@" &
mplayer_pid=&!

echo > /tmp/mplayer_tab

tail -f /tmp/mplayer_tab | {
    while read -r time; do
        echo "Tab at $time" >> /tmp/mplayer_out

        echo > /tmp/mplayer_rus

        cat "$rus_sub" | grep "$time,.*-->" -B 5 | tail -n +3 | {
            while read -r line; do
                line="$(echo "$line" | tr '\r' '@')"
                if [[ "$line" == "@" ]]; then
                    break
                fi

                echo "line: '$line'" >> /tmp/mplayer_out
                lines="$lines $line"
            done

            lines="$(sed 's/@//g' <<< "$lines")"
            lines="$(sed 's/  / /g' <<< "$lines")"

            echo "lines: '$lines'" >> /tmp/mplayer_out
            echo "$lines" > /tmp/mplayer_rus
        }

        rus="$(cat /tmp/mplayer_rus)"
        if [[ "$rus" != "" ]]; then
            notify-send -- "$rus"
        fi
    done
}

pkill mplayer
