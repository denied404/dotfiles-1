#!/bin/bash

pattern="$1"
shift

target="."
if [ -e $pattern ]; then
    target=$pattern
    pattern="*"
fi

RUN_ST=1
if [[ $1 =~ ^-?[0-9]+$ ]]; then
    RUN_ST=$1
    shift
fi

cmd_template="${@}"

N=0
inotifywait -m -e close_write --format %w%f $target 2>/dev/null |
    while read name
    do
        if ! grep -qE "$pattern" <<< "$name"; then
            continue
        fi

        if grep -qE "[0-9]+" <<< $(basename "$name"); then
            continue
        fi

        N=$((N+1))
        if [ $(bc <<< "$N%$RUN_ST") != "0"  ]; then
            continue
        fi

        echo -e '\e[1;44;1;37m:: '$name'\e[0m'

        export FILE="$name"
        export EXT=$(sed 's/.*\.//g' <<< "$FILE")

        cmd=$(sed 's|%s|'"$name"'|' <<< "$cmd_template")
        echo "$ $cmd"
        (
            eval "$cmd"
        )
    done

