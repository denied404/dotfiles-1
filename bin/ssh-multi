#!/bin/bash

if [ -s /dev/stdin ]; then
    cmd=$(cat)

    echo "servers: $*" >&2
    echo >&2
    echo "cmd: $cmd" >&2
    echo >&2
else
    cmd="$1"
    shift
fi

for server in ${@}; do
    echo "$server" >&2
    if ! ssh-keygen -F "$server" &>/dev/null; then
        output=$(
            { ssh-keyscan "$hostname" >> ~/.ssh/known_hosts; } 2>&1
        )
        if [ $? -ne 0 ]; then
            echo "$output" >&2
            continue
        fi
    fi

    echo "$cmd" | ssh \
        -oConnectTimeout=1 -oStrictHostKeyChecking=no "$server" \
        "cat > .cmd; sudo bash .cmd "
done
