#!/bin/bash

exec 200>/tmp/brightness.lock
flock 200

if [ "$(cat ~/.config/profile)" == "laptop" ]; then
    dir=/sys/class/backlight/intel_backlight
    step=100
else
    dir=/sys/class/backlight/acpi_video0
    step=1
fi

path=$dir/brightness
value=$(cat $path)

:notify() {
    notify-send.sh -r 2000 "brightness" "${1}"
}

:set() {
	echo "$*" | sudo tee $dir/brightness
}

if [ $# -eq 0 ]; then
	echo $value
elif [ $1 == "up" ]; then
    new_value=$(($value+$step))
	:set "$new_value"
    :notify "$new_value"
elif [ $1 == "down" ]; then
    new_value=$(($value-$step))
	:set "$new_value"
    :notify "$new_value"
elif [ $1 == "toggle" ]; then
    cached=$(cat ~/.cache/brightness.cache)
    if [[ ! "$cached" ]]; then
        if [[ "$value" == "0" ]]; then
            cached="1000"
        else
            echo "$value" | tee ~/.cache/brightness.cache
            :set 0
            exit
        fi
    fi

    :set "$cached"
    :notify "$cached"
    rm ~/.cache/brightness.cache
fi
