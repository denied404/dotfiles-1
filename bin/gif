#!/bin/bash

OUTPUT="$1"

if [[ "$OUTPUT" == "" ]]; then
    echo "usage: $0 <output.gif>"
    exit 1
fi

XWININFO=$(xwininfo)

ID=$(awk '/Window id/{print $4}' <<< "$XWININFO")

X=$(awk '/Absolute upper-left X/{print $4}' <<< "$XWININFO")
Y=$(awk '/Absolute upper-left Y/{print $4}' <<< "$XWININFO")
W=$(awk '/Width/{print $2}' <<< "$XWININFO")
H=$(awk '/Height/{print $2}' <<< "$XWININFO")

echo "Are you ready? Press ENTER to start recording"
read
xdotool windowfocus $ID

byzanz-record --verbose --delay=0 --x=$X --y=$Y --width=$W --height=$H \
    --exec="bash -c 'ping ya.ru > /dev/null'" $OUTPUT &
PID=$!

echo "Done? Press ENTER to stop recording"
read
pkill ping

while kill -0 "$PID"; do
    sleep 0.1
done
