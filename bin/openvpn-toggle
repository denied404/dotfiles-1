#!/bin/bash

[ -n "$_LOCK" ] || _LOCK=x exec flock -n $0 $0 "$@"

set -euo pipefail

PROFILE="mars"

:notify() {
    echo "$*"
    notify-send.sh -r 1000 -t 1000 " " -- "$*"
}

:ping() {
    ping -c 1 8.8.8.8 | grep -Po 'time=\K.*'
}


:main() {
    if sudo systemctl status openvpn@${PROFILE};
    then
        :notify "openvpn: stopping service"
        sudo systemctl stop openvpn@${PROFILE}
        :notify "openvpn: stopped service $(:ping)"
        pkill -f -9 openvpn-toggle
    else
        :notify "openvpn: starting service"
        sudo systemctl start openvpn@${PROFILE}
        until ip l | grep -q 'tap'; do
            sleep 0.1
            :notify "openvpn: initializing"
        done
        :notify "openvpn: ${PROFILE} $(:ping)"
    fi
}

:main "${@}"
