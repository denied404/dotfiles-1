#!/bin/bash

if findmnt /media/sony >&-; then
    sudo umount /media/sony
    echo Unmounted
else
    device=$(
        sudo lsblk -O --json |
            jq -r '.blockdevices | .[] | select(.vendor | startswith("Sony")) | select(.size != "2M") | .children[] | .path'
    )

    sudo mkdir -p /media/sony
    sudo chown $USER /media/sony
    uid=$(id -u)
    gid=$(id -g)
    sudo mount -o umask=0022,gid=$gid,uid=$uid $device /media/sony

    sxiv -o /media/sony/DCIM/100MSDCF/ | xargs -n1 -I{} rsync -avp {} ~/Dropbox/Photos/
    systemctl --user start dropbox
    started=false
    while :; do
        s=$(dropbox-cli status)
        echo "---------------------------------------------"
        date '+%T'
        echo "$s"
        if [[ "$s" =~ "Up to date" ]]; then
            if $started; then
                exit 0
            fi
        else
            started=true
        fi
        sleep 1
    done
fi
