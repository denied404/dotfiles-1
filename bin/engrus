#!/bin/bash

#set -x

input() {
    echo | dmenu -p "translate: "
}

if [[ "$1" != "" ]]; then
    CLI=true
    INPUT="$@"
else
    CLI=false
    INPUT=$(input)
fi

WORDS=$(wc -w <<< "$INPUT")

LANG="en-ru"
TEXT_AZ=$(grep -E '[a-zA-Z]' <<< "$INPUT")
if [[ "$TEXT_AZ" == "" ]]; then
    LANG="ru-en"
fi

if [[ $WORDS == 1 ]]; then
    TRANSLATION=$(runki --dry --lang $LANG 2>/dev/null <<< "$INPUT")

    if [[ "$TRANSLATION" != "" ]]; then
        runki --lang $LANG <<< "$INPUT" >/dev/null 2>&1 &
        disown
    fi
fi

if [[ "$TRANSLATION" == "" ]]; then
    INPUT=$(tr -s ' ' '+' <<< "$INPUT")
    KEY="trnsl.1.1.20150807T071843Z.319e163bafb5d806.f17c493a466253265a817c9f96a74db85f6b556b"
    URL="https://translate.yandex.net/api/v1.5/tr.json/translate?key=$KEY&lang=$LANG&text=$INPUT"
    TRANSLATION=$(curl -s "$URL" )
    TRANSLATION=$(jq .text[0] <<< "$TRANSLATION")
    TRANSLATION=$(sed 's/"//g' <<< "$TRANSLATION")
fi

if $CLI; then
    echo $TRANSLATION
else
    notify-send -t 2000 -- "$TRANSLATION"
fi
