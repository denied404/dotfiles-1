#!/bin/bash

# udev mode
if [ ! "$HOME" ]; then
    echo "udev"
    HOME=${HOME:-/home/operator}
    PATH=${PATH:-/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:$HOME/go/bin/}
    XAUTHORITY=${XAUTHORITY:-/home/operator/.Xauthority}
    DISPLAY=${DISPLAY:-:0.0}

    export HOME PATH DISPLAY XAUTHORITY

    notify-send -u low " " -- "new keyboard" &

    sleep 1
fi

KEYCODES="evdev+aliases(qwerty)+hjkl"
COMPAT="complete+hjkl"
SYMBOLS=(
    "pc"
    "us"
    "ru:2"

    "level3(lwin_switch)"
    "mod4-lvl3"

    "hjkl"
    "hjkl(caret)"
    "hjkl(fast-enter)"
    "hjkl(fast-escape)"


    #"capslock(escape)"
    "altwin(swap_alt_win)"
    #"bksp-last-group"
    #"ralt-first-group"

    "hjkl(fast-numpad)"
    "level5(ralt_switch)"
    #"hjkl(rtrn_switch)"

    "ctrl-shift-caps"
)

SYMBOLS=$(IFS="+"; echo "${SYMBOLS[*]}")

setxkbmap \
    -keycodes $KEYCODES \
    -symbols $SYMBOLS \
    -compat $COMPAT \
    -print \
    | xkbcomp -w 0 - $DISPLAY 2>&1  \
    | systemd-cat -t xkb

xset r rate 110 100
xset -b

pkill shift-shift
if ! pidof shift-shift > /dev/null; then
    HANDLER_ENG="CAPSLOCK"
    HANDLER_RUS="RIGHTSHIFT"
    if grep -q "Razer" /proc/bus/input/devices; then
        KEYBOARD="razer"
    else
        KEYBOARD="keyboard"
    fi

    {
        sudo shift-shift \
            -match "$KEYBOARD" \
            -first "$HANDLER_ENG" -second "$HANDLER_RUS" \
            | systemd-cat -t shift-shift
    } &

fi
