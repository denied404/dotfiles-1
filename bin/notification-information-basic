#!/bin/bash

:notify() {
    notify-send.sh -r 1000 -t 1000 " " -- "$*"
}

:body-append() {
    local section="$1"
    local content="$2"

    if [[ "${body:-}" ]]; then
        local endl=$'\n'
        body="${body}${endl}"
    fi

    body="${body}$(
        printf '<b>%-8s</b> %s' "$section" "$content"
    )"
}

:get-section-time() {
    TZ=${1:-} date +'%T %d-%m-%Y %a'
}

:get-section-battery() {
    acpi \
        | sed -r \
            -e 's/Battery [0-9]:\s*//' \
            -e 's/ until charged//' \
            -e 's/ remaining//' \
            -e 's/Discharging,/↓/' \
            -e 's/Full,/✓/' \
            -e 's/Charging,/↑/' \
            -e 's/,//'
}

:get-section-memory() {
    free -h -w \
        | awk '/^Mem:/ { print $4 " (" $8 ") of " $2}'
}

:get-section-cpu() {
    grep -P 'cpu\d' /proc/stat \
        | awk '{ usage=($2+$4)*100/($2+$4+$5); printf "%.0f%\n", usage }' \
        | tr '\n' ' '
}

:main() {
    local datetime=""
    local battery=""
    local body=""

    :body-append "TIME MSK" "$(:get-section-time Europe/Moscow)"
    :body-append "TIME PST" "$(:get-section-time PST8PDT)"
    :body-append "MEMORY" "$(:get-section-memory)"
    :body-append "CPU" "$(:get-section-cpu)"
    :body-append "BATTERY" "$(:get-section-battery)"

    :notify "$body"

    if pidof openvpn || pidof tor; then
        local location=$(my-location)
        if [[ "$location" ]]; then
            location=($location)
            if [[ "${location[0]}" == "${location[1]}" ]]; then
                location="${location[0]}"
            else
                location="${location[0]}: ${location[1]}"
            fi

            :body-append "GEO" "$location"

            :notify "$body"
        fi
    fi

}

:main "${@}"
